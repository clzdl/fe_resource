/**
 * Created by Administrator on 2017/4/6 0006.
 */

  function getQuery() {
     var query = window.location.search.substr(1),urlCs=query.split('&'),
         length=urlCs?urlCs.length:0,i=0,data={},equal,
        slice=Array.slice
      if(length == 0){
          return {

          }
      }
      for(;i<length;i++){
          equal=urlCs[i].indexOf("=");
          if(equal == -1){
              continue ;
          }
          data[urlCs[i].substr(0,equal)]=unescape(urlCs[i].substr(equal+1));
      }
       return data
   }
  function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
   }

  // 判断是不是分享

 if(getQueryString('from'))
  window.location.href='http://event.easteat.com/wx/oauth/getauthorizeurlbyjs/1/?scope=snsapi_base&redirectUrl=' +
      encodeURIComponent("http://event.easteat.com/register/hzfree.html").toLowerCase();



$(function () {
     console.log('start')
    var num=1,
        name=$('#name'),
        tele=$('#tele'),
        company=$('#company'),
        tip=$('.tip-text'),
        sf='',
        lx='',
        zw='',
        mudi='',
        getMsg='',
        reg=/^1\d{10}$/,//电话正则

        k,//循环函数
        loaction=window.location.href,//本页地址
        userMsg,
        domainUrl='http://event.easteat.com',
        activityEnName='ydylmsjldh-free',
        // domainUrl='http://localhost:8080',
        postDataApi=domainUrl+'/register/save.json', //提交信息
        checkBuyApi=domainUrl+'/register/getqrcodeinfobyopenid.json';//验证 是否购买

    function Tip(elem,text) {
        elem.text(text).fadeIn().delay(500).fadeOut()
    }

 //查看是否购买
    $.ajax({
        url:checkBuyApi,
        type:'GET',
        data:{
            activityEnName: activityEnName,
            openid: getQueryString('openid')
        },
        success:function (data) {

            if(data.flag&&data.flag === 1){
                if(data.data&&data.data.list.length > 0) {
                    $('#old-buy').removeClass('none').on('click',function () {
                        window.location.href='./hzfree-buy-result.html?openid='+getQueryString('openid')
                    })
                }
            }
            else {
                console.log('no')
            }
        }

    })




    function postWX() {
        var nameV=name.val(),teleV=tele.val(),companyV=company.val(),postData=getQuery();
        postData.payNum=1;
        postData.field0=nameV;
        postData.field1=teleV;
        postData.field2=companyV;
        postData.field3= sf == "其他" ? $("#sf .special-in").val() : sf;
        postData.field4= lx ;
        postData.field5= zw== "其他" ? $("#zw .special-in").val() : zw;
        postData.field6= mudi == "其他" ? $("#mudi .special-in").val() : mudi;
        postData.field7= getMsg == "其他" ? $("#getmsg .special-in").val() : getMsg;
        postData.activityEnName= activityEnName;
        console.log(postData)
        $('.load').show()
        $.ajax(
            {
                url:postDataApi,
                async:true,
                cache:false,
                type:'POST',
                data:postData,
                error:function (i,j,k) {
                   console.log(i,j,k)
                },
                success:function (data) {
                           console.log(data)
                    if( data.flag&&data.flag === 1 ){
                        $("#post").attr({'data-on':1});
                       window.location='./hzfree-buy-result.html?openid='+getQueryString('openid');
                    }
                }
            }
        )

    }

    //重复 可改成函数

    $("#sf input[name='sf']").on('click',function () {
        var elem = $(this)
        sf=$("#sf input[name='sf']:checked").val();

        sf == '其他' ? elem .parents('.select').find('.special-in').removeClass('none') :
            elem .parents('.select').find('.special-in').addClass('none').val('')
    })


    $("#zw input[name='zw']").on('click',function () {
        var elem = $(this)
        zw=$("#zw input[name='zw']:checked").val();

        zw == '其他' ?elem.parents('.select').find('.special-in').removeClass('none') :
            elem .parents('.select').find('.special-in').addClass('none').val('')
    })

    $("#getmsg input[name='getmsg']").on('click',function () {
        var elem = $(this)
        getMsg=$("#getmsg input[name='getmsg']:checked").val();

        getMsg == '其他' ?elem.parents('.select').find('.special-in').removeClass('none') :
            elem .parents('.select').find('.special-in').addClass('none').val('')
    })

    $("#mudi input[name='mudi']").on('click',function () {
        var elem = $(this)
        mudi=$("#mudi input[name='mudi']:checked").val();

        mudi == '其他' ?elem.parents('.select').find('.special-in').removeClass('none') :
            elem .parents('.select').find('.special-in').addClass('none').val('')
    })

    //

    $("#lx input[name='lx']").on('click',function () {
        lx = '';
        $("input[name='lx']:checked").each(function () {
            lx+=$(this).val()+',';
        })
        console.log(lx)
    })
    $('#post').on('click',function () {
        var nameV=name.val(),teleV=tele.val(),companyV=company.val()
        if($.trim(nameV)==''){
            alert('姓名不能为空')
            return false
        }
        if(!reg.test(teleV)){
            alert('电话格式不正确')
            return false
        }

        if( $.trim(companyV) == ''){
            alert('公司不能为空')
            return false
        }

        if( sf =='' ){
            alert('身份必选')
            return false
        }else{

                if(  sf == '其他' && $.trim($("#sf .special-in").val()) == '') {
                    alert('请输入身份')
                    return false
                }


        }

        if( zw== '' ){
            alert('职位必选')
            return false
        }else{
            if( zw == '其他' && $.trim($("#zw .special-in").val()) == '') {
                alert('请输入职位')
                return false
            }
        }

        if( getMsg=='' ){
            alert('获取渠道必选')
            return false
        }else{
            if( getMsg == '其他' &&$.trim($("#getmsg .special-in").val()) == '') {
                alert('请输入渠道')
                return false
            }
        }

        if( lx == '' ){
            alert('请选择公司类型')
             return false
        }

        if( mudi=='' ){
            alert('目的必选')
            return false
        }else{
            if( zw == '目的' && $.trim($("#mudi .special-in").val())) {
                alert('请输入目的')
                return false
            }
        }

        console.log('post')
        console.log($(this).attr('data-on'))
         if( !$(this).attr('data-on') )
             postWX()
    })


})